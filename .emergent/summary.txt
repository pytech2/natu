<analysis>**original_problem_statement:** The user wants a full-stack web application for a company named **NSTU India Private Limited** to manage property tax notice distribution and surveys. The application requires different user roles (Admin, Surveyor, Supervisor, MC Officer), bulk data upload via Excel and PDF, property assignment, a surveyor mobile interface for data collection (including photos with GPS watermarks and signatures), and an admin dashboard for progress tracking, review/approval, and data export.

**PRODUCT REQUIREMENTS:**
- **Roles:** Super Admin, Surveyor, Supervisor, MC Officer with specific permissions.
- **Admin Workflow:** Login, upload property data (Excel/PDF), manage users (mobile as login, password reset), assign properties to single or multiple employees, view a dashboard with stats (including attendance), review/approve/reject submissions, export data, and view properties on a map with logical route sorting.
- **PDF Bill Processing System:** A complete workflow to extract data from multi-page PDFs, store it, filter by colony, sort by a logical GPS walking route, re-number serials, generate new arranged PDFs (with serial numbers printed correctly, even on rotated pages), and allow editing of extracted bill data with PDF regeneration.
- **Surveyor Workflow:** Login (using mobile number), view assigned properties, and submit a survey. The survey form is highly customized with specific fields, allows only one photo, and has a 10-minute inactivity auto-logout.
- **Attendance:** A one-time daily attendance system for surveyors with a selfie, visible on the admin dashboard and a dedicated admin attendance page.

**User's preferred language**: English and Hindi (mixed). The agent should respond primarily in **English**.

**what currently exists?**
A full-stack application with a FastAPI backend, React frontend, and MongoDB database, featuring JWT authentication and role-based access.
- **Backend:** A monolithic  handles all API logic. It includes PDF data extraction (), PDF generation (), and a sophisticated GPS route sorting algorithm (nearest-neighbor on unique coordinates). User authentication has been modified to use mobile numbers as usernames.
- **Frontend:**
    - **Admin Panel:** A comprehensive dashboard with user management (mobile login, password reset), property management (bulk multi-employee assignment), and a full-featured PDF Bill processing system. The map views (, ) can now display thousands of markers by spreading out overlapping points and follow a logical walking-route serial numbering. An attendance page and dashboard widget have been added.
    - **Employee/Surveyor Panel:** The survey form has been completely overhauled to match recent user specifications, removing and adding several fields and reducing photo uploads to one.
- **General:** An auto-logout feature after 10 minutes of inactivity has been implemented across the application. The UI has been updated with the company name in all caps and a more compact sidebar.

**Last working item**:
- **Last item agent was working:** Debugging a critical issue where properties assigned to multiple employees were not showing up after the respective employees logged in. This was blocked by another issue where employee login was failing with Invalid credentials even after a password reset.
- **Status:** BLOCKED
- **Agent Testing Done:** N (Testing was in progress but failed).
- **Which testing method agent to use?** both
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1:** Employee login fails and assigned properties are not visible. (P0)
- **Issue 2:** The mobile photo watermark bug persists. (P1)
- **Issue 3:** Full verification of all recent features requested by the user is pending. (P1)

**Issues Detail:**
- **Issue 1: Employee login fails and assigned properties are not visible.**
    - **Description:** After implementing multi-employee assignment, an employee assigned to properties cannot see them upon login. The immediate blocker is that the employee login itself is failing with Invalid credentials, preventing further testing.
    - **Attempted fixes:** The agent updated backend queries to use the  array. The agent also implemented and used a password reset function for an employee (), but the subsequent login attempt failed.
    - **Next debug checklist:**
        1.  In , thoroughly investigate the  endpoint. Check the password hashing () and verification () logic.
        2.  Verify the  endpoint correctly updates the user's password hash in the database.
        3.  Once login is fixed, log in as an employee assigned to properties.
        4.  Debug the  endpoint to ensure it correctly queries the  collection using the  operator on the  field.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** both
    - **Blocked on other issue:** None

- **Issue 2: Mobile Photo Watermark Bug**
    - **Description:** When a surveyor uses a mobile device to take a photo directly via the camera input, the GPS/timestamp watermark is not applied. This is a long-standing issue.
    - **Attempted fixes:** A previous agent added  logic in  to handle mobile file objects. The current agent has only viewed this code, not tested it.
    - **Next debug checklist:**
        1.  Use mobile simulation in the browser's developer tools.
        2.  Log in as a surveyor and open a survey for an assigned property.
        3.  Use the Take Photo option, which triggers the device camera.
        4.  Submit the survey and log in as an admin to review the submission.
        5.  Check the submitted image to see if the watermark is present. If not, investigate the  function in .
    - **Status:** NOT STARTED
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** frontend
    - **Blocked on other issue:** None

- **Issue 3: Full verification of recent features.**
    - **Description:** The user made a large number of requests (mobile login, new survey form, auto-logout, admin role restrictions) which were implemented but not fully verified due to the login blocker.
    - **Attempted fixes:** The agent implemented all required code changes in the frontend and backend.
    - **Next debug checklist:**
        1.  **Employee Creation/Login**: Confirm a new employee can be created with a mobile number and can log in successfully.
        2.  **Survey Form**: As a logged-in employee, access the survey form and verify all fields match the user's latest request.
        3.  **Auto-Logout**: Confirm the application automatically logs out after 10 minutes of inactivity.
        4.  **Role Permissions**: Log in as a 'SUPERVISOR' and verify that the PDF upload and generation features are not visible/accessible.
    - **Status:** BLOCKED
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** both
    - **Blocked on other issue:** Issue 1

**In progress Task List**:
- None. All current work is categorized under the issues above.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - **Backend Refactoring (P0):** Decompose the monolithic  (now over 2600 lines) into a modular structure using FastAPI routers (e.g., , , ). An initial  file exists as a template. This is critical for maintainability.
- **Future Tasks:**
    - **Offline Support:** Enable the surveyor's mobile interface to work offline and sync data later.
    - **Download ZIP:** Add a feature to download all split-employee PDFs as a single ZIP file.

**Completed work in this session**
- **Feature (PDF Serial Numbers):** Successfully fixed the placement of serial numbers on generated PDFs, accounting for 90-degree page rotation.
- **Feature (Map Visualization):** Implemented a marker-spreading algorithm on both  and  to prevent overlapping pins, ensuring all properties are visible.
- **Feature (GPS Route Sorting):** Significantly improved the Arrange by GPS Route algorithm to create a logical walking path for surveyors, even when multiple properties share the same coordinates.
- **Feature (Employee/Property Assignment):** Implemented multi-employee assignment for properties from the admin panel.
- **Feature (User Management):** Shifted from username to mobile number for login and added a password reset function for admins.
- **Feature (Survey Form Overhaul):** Completely redesigned the  form based on detailed user feedback, changing fields and limiting photo uploads.
- **Feature (Session Management):** Implemented a 10-minute inactivity auto-logout mechanism.
- **Feature (Admin UI):** Added an attendance page and a dashboard widget. Made several UI tweaks like capitalizing the company name and adjusting sidebar styling.
- **Bug Fix (Data Deletion):** Ensured Delete All correctly clears the properties collection.

**Earlier issues found/mentioned but not fixed**
- **Issue 1: Mobile Photo Watermark Bug**
    - **Debug checklist:** See Issues Detail section above.
    - **Why to solve this issue and what will be achieved with this?** This is a core requirement for verifying the location and time of a survey photo.
    - **Should Test frontend/backend/both after fix:** frontend
    - **Is recurring issue?** Y

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork:** Mobile Photo Watermark Bug
- **Recurrence count:** 2+
- **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, MongoDB (Motor), JWT, PyMuPDF (for PDF reading/manipulation), reportlab (for PDF generation).
- **Frontend:** React, React-Leaflet, Tailwind CSS, Shadcn UI, Axios.
- **Algorithms:** Nearest-neighbor for GPS route sorting, spiral algorithm for spreading overlapping map markers.

**key DB schema**
- **users:**  field is now populated with the mobile number.
- **properties:**  (string) is being deprecated in favor of  (array of strings).
- **submissions:** Schema updated with new fields like , , ,  and removed , .

**changes in tech stack**
- No new libraries were added, but heavy use of  and  was made to solve complex PDF manipulation challenges.

**All files of reference**
-  (Heavily modified for all new features and bug fixes)
-  (Multi-employee assignment UI)
-  (Mobile login UI, password reset button)
-  (Complete form overhaul)
-  &  (Marker spreading logic)
-  (Auto-logout logic)
-  (New admin page)
-  (Attendance widget)
-  (UI tweaks)
-  (New routes)
-  (New file for future refactoring)

**Areas that need refactoring**:
- **:** This is the highest priority for refactoring. The file is over 2600 lines long and contains all logic for users, properties, bills, surveys, and authentication. It is becoming unmaintainable. The agent started by creating , and this effort should be completed.

**key api endpoints**
- : (Needs debugging) For user login, now uses mobile number.
- :  (New) to reset an employee's password.
- :  (Modified) to accept an array of .
- :  (Needs debugging) to fetch properties for the logged-in employee.
- :  (New) to fetch attendance data for the admin page.
- :  (Modified) to accept the new survey form fields.

**Critical Info for New Agent**
- **Your top priority is to fix the employee login issue.** Without this, most of the recent features cannot be verified. The problem likely lies in the password verification logic in .
- Once login is fixed, you must verify that the multi-employee assignment is working end-to-end.
- The user has provided a very large number of requirements in the last few interactions. A full verification pass of all of them is necessary after the login blocker is resolved.
- **Do not start new features until the backend refactoring is done.** The  file is too large. Propose this refactoring to the user as the next major step after fixing the current critical bugs.

**documents and test reports created in this job**
- 
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST):** Requested a large batch of new features and changes, including using mobile for login, a password reset option, a complete overhaul of the survey form, a 10-minute auto-logout, and role permission changes. **Status: IN PROGRESS (implementation done, but blocked on verification).**
2.  **User:** Stated that properties assigned to an employee are not showing up and the select box for assignment is not working correctly. **Status: IN PROGRESS (agent attempted fixes).**
3.  **User:** Provided a list of new requirements: remove all batches in Property Management, implement multi-select employee assignment, add an attendance page/dashboard widget, fix a missing map category, add mobile number to survey ID, and make UI text changes. **Status: Completed.**
4.  **User:** Reported that the map markers are not in a sequential walking order and provided an image. **Status: Completed.**
5.  **User:** Reported that properties with serial numbers 1, 2, 3 are missing from the map. **Status: Completed (fixed by spreading overlapping markers).**
6.  **User:** Stated the serial number should be used for the map markers to solve ordering problems. **Status: Confirmed (system already works this way).**
7.  **User:** Reported that the bill serial number is still not showing on the generated PDF. **Status: Completed (fixed by handling page rotation).**
8.  **User:** Requested the serial number format be changed to plain numbers (1, 2, 3...). **Status: Completed.**
9.  **User:** Provided new requirements for the PDF Bills page: a Delete All button, an Add to Properties button, and changes to the Split by Employee and Generate PDF functions. **Status: Completed.**
10. **User:** Said complete all pending. **Status: IN PROGRESS.**

**Project Health Check:**
- **Broken:** Yes. The employee login and property assignment flow is broken, which is a critical part of the application's workflow.
- **Mocked:** None.

**3rd Party Integrations**
- **Leaflet & React-Leaflet:** Used for interactive maps.
- **PyMuPDF, pytesseract, pdf2image, reportlab:** Dependencies for the PDF processing workflow.

**Testing status**
- **Testing agent used after significant changes:** YES (but before the latest user requests and bug reports).
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** None
- **Known regressions:** Properties not showing for assigned employees (new regression). Mobile watermark bug (old regression).

**Credentials to test flow:**
- **Admin:**  / 
- **Employee/Surveyor:** Must be created via the admin panel using a mobile number as the login ID. The agent attempted to reset the password for user  but login failed. This needs to be debugged.

**What agent forgot to execute**
The agent did not forget any tasks. Instead, the agent correctly identified the critical login bug as a blocker and was in the middle of debugging it when the session ended. The full verification of the user's latest large set of requests is pending due to this blocker. The backend refactoring was started but not completed, which is a significant pending architectural task.</analysis>
