<analysis>**original_problem_statement:** The user wants a full-stack web application for a company named **NSTU India Private Limited** to manage property tax notice distribution and surveys. The application requires different user roles (Admin, Surveyor, Supervisor, MC Officer), bulk data upload via Excel and PDF, property assignment, a surveyor mobile interface for data collection (including photos with GPS watermarks and signatures), and an admin dashboard for progress tracking, review/approval, and data export.

**PRODUCT REQUIREMENTS:**
- **Roles:** Super Admin, Surveyor, Supervisor, MC Officer with specific permissions.
- **Admin Workflow:** Login, upload property data (Excel/PDF), manage users, assign properties. A key requirement is processing PDF bills: extracting data (including the bill's own serial number), handling missing serials as N/A, and allowing a manually triggered GPS-based re-arrangement of bills for route optimization. The admin must be able to view properties on a satellite map, track employee attendance/location, review survey submissions, and export Approved data.
- **Surveyor Workflow:** Login, view assigned properties on a high-quality satellite map that tracks their live location and highlights the nearest property. The map should be printable as a PDF for field use. The survey form must support special conditions like House Locked or Owner Denied, which alter the required fields. A Self-Certified status must be captured via a radio button.
- **Attendance:** A daily attendance system for surveyors with a selfie, visible on the admin dashboard.
- **PDF Generation:** The admin needs to generate PDFs of bills. The latest requirement is to render 1, 2, or 3 source bills onto a single A4 page, without cropping or incorrect rotation, and with minimal whitespace.

**User's preferred language**: The user communicates in a mix of English and Hindi. The next agent MUST be prepared to understand and respond to instructions in both languages.

**what currently exists?**
A full-stack application with a FastAPI backend, React frontend, and MongoDB.
- **Backend:** A monolithic  handles all logic. It features a heavily-modified PDF generation endpoint that can render 1, 2, or 3 bills per page by converting source PDF pages to images and placing them on a new canvas. The file upload strategy was reverted from MongoDB GridFS back to a simpler filesystem approach () to reduce deployment complexity.
- **Frontend:**
    - **Admin Panel:** The Generate PDF dialog allows selecting 1, 2, or 3 bills per page. The main map and other property lists have an updated color scheme for property statuses. The submission review dialog's fields are now synchronized with the surveyor's form.
    - **Live Server (Hostinger VPS):** The application is deployed but is currently in a broken state where newly uploaded images are not loading. The configuration uses Nginx to serve a static frontend build and reverse proxy API calls to the Python backend.

**Last working item**:
- **Last item agent was working:** The agent was trying to resolve a critical  error for newly uploaded images on the user's live Hostinger VPS. Despite confirming the image file exists in the correct directory () and updating the Nginx configuration multiple times, Nginx fails to serve the file.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** Manual debugging on the VPS. The agent needs to use , check Nginx configuration (), and analyze Nginx logs ().
- **User Testing Done:** Y (User has confirmed the issue persists on the live server).

**All Pending/In progress Issue list**:
- **Issue 1:** Fix image loading  error on the live Hostinger VPS. (P0)
- **Issue 2:** User verification for the final PDF generation quality (size, spacing for 2 and 3 bills per page). (P1)
- **Issue 3:** User verification for the new map marker colors on the live server. (P1)
- **Issue 4:** User verification for the synced fields on the Admin Submission view page. (P2)
- **Issue 5:** Surveyor app performance and UI bugs (from previous handoff). (P3)
- **Issue 6:** Mobile photo watermark bug (recurring issue from previous handoff). (P3)

**Issues Detail:**
- **Issue 1: Fix image loading 404 error on Hostinger VPS**
    - **Description:** On the live server (), any attempt to access a recently uploaded image via its URL () results in a 404 error. This breaks the survey review workflow. The issue is purely a server configuration problem, likely in Nginx.
    - **Attempted fixes:**
        - Confirmed files exist in the target directory ().
        - Set up a symlink from the app's local  directory to .
        - Corrected file permissions and ownership ().
        - Rewrote the Nginx config () to remove duplicate  blocks and ensure a correct  directive for .
        - Restarted Nginx and the backend service () multiple times.
    - **Next debug checklist:**
        1.  Analyze the full Nginx config again () for subtle errors. The last attempt to fix it failed due to a  error, which was then resolved, but the problem persists.
        2.  Check the Nginx error logs () immediately after trying to access a broken image URL. This is the most crucial next step.
        3.  Verify the directory permissions recursively for the  user, ensuring it has execute () permissions on , , and .
        4.  Check for security policies like SELinux or AppArmor that might be blocking Nginx. Run  or check .
    - **Status:** IN PROGRESS
    - **Is recurring issue?** Y (Deployment issues are constant).
    - **Should Test frontend/backend/both after fix?** both (by accessing the live app in a browser).
    - **Blocked on other issue:** None. This is the primary blocker.

**In progress Task List**:
- None.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - **Backend Refactoring (P0):** Decompose the monolithic  into a modular structure using FastAPI routers. This is critical for maintainability.
- **Future Tasks:**
    - **Offline Support:** Enable the surveyor's mobile interface to work offline and sync data later.
    - **Download ZIP:** Add a feature to download all split-employee PDFs as a single ZIP file.
    - **Remove Employee:** Add a UI feature to remove a single employee from a property that is assigned to multiple people.

**Completed work in this session**
- **PDF Generation Overhaul:**
    - Resolved persistent cropping, rotation, and whitespace issues by implementing a new strategy: rendering source PDF pages as images and placing them on a clean A4 canvas.
    - Added UI and backend logic to allow users to generate PDFs with 1, 2, or 3 bills per page.
    - Iteratively adjusted bill size and spacing based on direct user feedback.
- **Map and UI Color Scheme Update:**
    - Changed the property status colors across the application (Admin Map, Employee pages) to a new scheme: Red (Pending/Rejected), Yellow (Submitted/In Progress), Green (Approved).
- **Admin Form Synchronization:**
    - The Admin's View/Edit Submission dialog now shows the same fields as the Surveyor's form, removing outdated fields and adding missing ones for consistency.
- **Extensive Live Server (VPS) Troubleshooting:**
    - Resolved MongoDB crashes by cleaning up disk space.
    - Identified the correct  service name () for managing the backend process.
    - Reverted the file storage strategy from MongoDB GridFS back to the simpler filesystem model to resolve deployment friction.
    - Performed multiple rounds of debugging on the Nginx configuration and file permissions.

**Earlier issues found/mentioned but not fixed**
- The surveyor app performance issues and the mobile photo watermark bug are long-standing issues that have been deprioritized to handle the critical PDF generation and deployment blockers.

**Known issue recurrence from previous fork**
- **Issue:** Mobile Photo Watermark Bug
- **Recurrence count:** 2+
- **Status:** USER VERIFICATION PENDING

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, MongoDB (Motor), PyMuPDF, reportlab.
- **Frontend:** React, React-Leaflet, Tailwind CSS, Shadcn UI.
- **Deployment:** Nginx, , Linux file permissions, symlinks. The agent has extensive hands-on experience debugging a live Linux environment.

**key DB schema**
- No new schema changes. A data migration was performed to update  with status  to .

**changes in tech stack**
- The use of MongoDB GridFS for file storage was implemented and then **reverted** in favor of a simpler filesystem approach due to deployment complexity.

**All files of reference**
- : Major changes to the  function. Logic for file upload/serving was simplified to rely on filesystem paths served by Nginx.
- : UI updated with a dropdown for 1, 2, or 3 bills per page.
- , : Updated with the new color-coding logic.
- : Overhauled the view/edit dialog to match the surveyor's form.

**Areas that need refactoring**:
- **:** This remains the highest priority for refactoring. The PDF generation function, after many iterations, is likely complex and could be cleaned up.

**key api endpoints**
- : The heavily modified endpoint for creating multi-bill PDFs.
- : This is not a direct FastAPI endpoint but is supposed to be served by Nginx. It is the source of the current P0 issue on the live server.

**Critical Info for New Agent**
- **Your immediate and highest priority task is to fix the image loading  error on the user's Hostinger VPS.** The live application is broken. This is an Nginx configuration issue, not an application code issue.
- **Focus your debugging on the VPS.** Scrutinize the Nginx config (), Nginx error logs (), and directory permissions from the root path down to the file (). The  user must be able to traverse the entire path.
- The file storage strategy is simple: the FastAPI backend writes files to a directory, and Nginx is supposed to serve them. Do not attempt to re-introduce database storage (GridFS), as this was abandoned to simplify deployment.
- The user is frustrated with the recurring deployment issues. Provide a final, definitive fix for the Nginx configuration.
- After fixing the deployment issue, you must get user verification on the other completed work: PDF quality and map colors.

**documents and test reports created in this job**
- 

**Last 10 User Messages and any pending HUMAN messages**
1. **LATEST:** User confirms they are unable to fix the Nginx config issue.
2. User asks for the command to restart services.
3. User shares a screenshot of the Nginx config test failing with a duplicate location error.
4. User confirms they need to restart services.
5. User states the image loading issue is not fixed ().
6. User reports the backend service is failing to start on the VPS.
7. User provides a screenshot of the 404 error for an image on the live server, stating that it works on the preview environment but not on their VPS. This is the core of the current problem.
8. User asks for a single, final command to update the entire codebase on the VPS and make it work like the preview environment.
9. User reports that on the VPS, today's uploaded images are not showing, and new uploads are not working, while yesterday's images are fine.
10. User reports that backend                          RUNNING   pid 48, uptime 0:00:03
code-server                      STOPPED   Not started
frontend                         STOPPED   Jan 16 08:35 AM
mongodb                          RUNNING   pid 50, uptime 0:00:03
nginx-code-proxy                 RUNNING   pid 47, uptime 0:00:03
supervisor>  is not found and asks for the correct restart command.

**Project Health Check:**
- **Broken:** The live application on the Hostinger VPS is critically impacted. The inability to view newly uploaded survey images makes the core workflow unusable.
- **Mocked:** None.

**3rd Party Integrations**
- **Leaflet & React-Leaflet:** Used for all interactive maps.
- **PyMuPDF, reportlab:** Backend dependencies for PDF processing.
- **Nginx:** Used as a reverse proxy and static file server on the live VPS.

**Testing status**
- **Testing agent used after significant changes:** NO
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** None.
- **Known regressions:** The image loading functionality is regressed on the live server due to a deployment/configuration issue.

**Credentials to test flow:**
- **Admin:**  / 
- **Employee/Surveyor:** Create via the admin panel.

**What agent forgot to execute**
- All secondary tasks (refactoring, older bugs) were justifiably postponed to address the P0 PDF generation and deployment crises. The agent was entirely focused on the user's immediate blockers.</analysis>
