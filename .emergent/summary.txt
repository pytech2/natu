<analysis>**original_problem_statement:** The user wants a full-stack web application for a company named **NSTU India Private Limited** to manage property tax notice distribution and surveys.

**PRODUCT REQUIREMENTS:**
- **Roles:** Super Admin (1) and Field Employees/Surveyors (~15).
- **Admin Workflow:**
    - Login.
    - Upload large property datasets (50,000+ records) via CSV/Excel.
    - Create/Manage users (Surveyors, Supervisors, MC Officers).
    - Assign properties to surveyors by area.
    - View a dashboard with progress stats (e.g., total, completed, pending, today's completion).
    - Review submissions, with options to approve or reject (with remarks).
    - Export survey data (including photos, GPS, signatures) to Excel and PDF.
    - Archive/delete old datasets.
- **Surveyor Workflow:**
    - Login (mobile-friendly UI).
    - View a list of assigned properties.
    - For each property, fill a survey form with new/updated information (new owner, mobile, receiver name, relation, etc.).
    - Capture proof of visit:
        - Photos of the property (via camera or upload).
        - Photos must be watermarked with GPS coordinates, date, and time.
        - Digital signature from the property holder on the device.
    - The app must auto-capture GPS coordinates and a timestamp on submission.
- **Data Model:**
    - Uploaded data includes: , , , , .
    - Survey data includes: , , , , , , , , and .

**User's preferred language**: English

**what currently exists?**
A full-stack application with a FastAPI backend and React frontend has been developed. It uses JWT for authentication and MongoDB for the database.
- **Admin Panel:** Features for login, dashboard, user management, property data upload (CSV), and viewing submissions are implemented. Excel and PDF export functionalities are also present.
- **Employee/Surveyor Panel:** A mobile-friendly interface allows surveyors to log in, view assigned properties, and submit a survey. The survey form includes photo uploads, GPS capture, and a digital signature pad.
- **Recent Changes:** The agent began a major update to align with new user requirements, including new user roles, a revised data model for uploads, UI changes to the admin dashboard, and new fields in the survey form. This work is incomplete, and the application is in a transitional, likely non-functional state.

**Last working item**:
- **Last item agent was working:** The agent was in the middle of implementing a large set of feature changes and refactoring requested by the user in their last detailed message. It had just overwritten , , and  and was about to modify .
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** both
- **User Testing Done:** N

**All Pending/In progress Issue list**:
- **Issue 1:** Complete the large feature update from the user's latest request (P0)
- **Issue 2:** Fix the photo watermark bug on mobile devices (P1)

**Issues Detail:**
- **Issue 1: Complete large feature update**
    - **Description:** Implement all changes requested by the user in message #212. This is a large, multi-part task.
        1.  **Role Change:** Change field employee to Surveyor and add new roles: Supervisor, MC Officer.
        2.  **Data Model Update:** Modify the Excel upload format to use , , , , . Remove  and .
        3.  **Admin Dashboard Update:** Add Today complete property and Today complete ward stats. Make the employee progress report clickable.
        4.  **Surveyor Dashboard Update:** Show Total complete data below today progress.
        5.  **Workflow Update:** Rename Flagged status to Reject. Allow surveyors to edit their own submissions. Add Approve and Reject (with mandatory remarks) options for Admins.
        6.  **New Survey Fields:** Add fields for , , , , , , , , and .
    - **Attempted fixes:** The agent started by overwriting , , and . The work is mid-flight.
    - **Next debug checklist:**
        1.  Verify changes in  for new roles, data models, and submission statuses.
        2.  Continue frontend implementation:
            - Update  for Approve/Reject functionality.
            - Update  with new stats.
            - Overhaul  to include all new form fields.
            - Implement the edit submission flow for surveyors.
        3.  Update the backend API endpoints to support all the new data fields and workflow logic.
    - **Status:** IN PROGRESS
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** both
    - **Blocked on other issue:** None

- **Issue 2: Mobile Photo Watermark Bug**
    - **Description:** When a surveyor uses a mobile device to take a photo with the camera, the GPS/timestamp watermark is not saved/displayed on the final submission, although it works correctly when uploading a file from a desktop.
    - **Attempted fixes:** The agent rewrote  to use  instead of , aiming to improve compatibility with mobile browsers. This fix has not been verified by the user.
    - **Next debug checklist:**
        1.  Perform an end-to-end test on a simulated mobile view.
        2.  Log in as a surveyor, navigate to the survey form, and use the Take Photo button.
        3.  Confirm the watermark appears on the image preview *before* submission.
        4.  Submit the form.
        5.  Log in as an admin and check the submission to see if the saved photo has the watermark.
        6.  If the issue persists, investigate the  canvas logic in  for mobile browser-specific issues.
    - **Status:** USER VERIFICATION PENDING
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** both

**In progress Task List**:
- **Task 1: Complete Major Application Refactor (P0)**
    - **Where to resume:** The agent has already updated , , and . The immediate next step is to update  to add the Approve/Reject functionality. After that, proceed with the remaining items from the user's request (new survey fields, employee dashboard changes, etc.).
    - **What will be achieved with this?** The application will meet the user's updated and more detailed business requirements.
    - **Status:** IN PROGRESS
    - **Should Test frontend/backend/both after fix?** both
    - **Blocked on something:** None

**Upcoming and Future Tasks**
There are no other future tasks defined beyond the extensive refactoring currently in progress.

**Completed work in this session**
- **Initial Application Build:** A complete MVP of the full-stack application was created.
- **Authentication:** JWT-based auth for Admin and Employee roles was implemented.
- **Core Features:**
    - Admin: User management, CSV data upload, submission viewing.
    - Employee: Viewing assigned properties, filling survey form.
- **Advanced Features:**
    - **Digital Signature:** Implemented a signature pad on the survey form using .
    - **Photo Watermarking:** Logic to add GPS/timestamp watermarks to photos was added (though it's buggy on mobile).
    - **Data Export:** Added functionality to export data to Excel and PDF reports (including photos and signatures).
- **UI/UX:**
    - Removed the Made with Emergent badge.
    - Improved mobile UI for the survey form with distinct Take Photo and Upload buttons and a full-width signature pad.

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI, MongoDB with Motor (async driver), JWT for auth (), Passlib for hashing.
- **Frontend:** React, React Router, Tailwind CSS, Shadcn UI components, Axios.
- **File Handling:**  for uploads, local file storage for images/signatures.
- **Features:**
    - **Digital Signature:** .
    - **Photo Watermarking:** HTML5 Canvas API on the frontend to draw text on images.
    - **Excel Export:** .
    - **PDF Export:** , .

**key DB schema**
- **users:** , , ,  (Enum: ADMIN, EMPLOYEE, SUPERVISOR, MC_OFFICER), .
- **properties:** , , , , ,  (Enum: Pending, InProgress, Completed, Reject), .
- **survey_submissions:** , , , , , , , and all new survey fields (, , etc.).

**changes in tech stack**
- The project was implemented with **MongoDB**, deviating from the initial prompt which suggested PostgreSQL.
- Frontend dependencies added: , , , , .
- Backend dependencies added: To use the fastapi command, please install "fastapi[standard]":

	pip install "fastapi[standard]", , , , , , , , , .

**All files of reference**
- : The monolithic backend file, recently overwritten to begin a major refactor.
- : A large, complex component for the survey form. It handles state for form fields, GPS, photo capture/upload, watermarking, and the signature pad. It was overwritten multiple times to fix bugs and add features.
- : Admin dashboard display. Recently overwritten.
- : Employee management page. Recently overwritten.
- : Page for viewing submissions. Needs to be updated for Approve/Reject functionality.
- : Governs the data upload process. Needs to be updated for the new CSV format.
- : Project Requirements Document created by the agent.

**Areas that need refactoring**
- **:** This single file contains all models, API endpoints, and business logic. It should be broken down into a standard FastAPI project structure (e.g., , , ).
- **:** This component is overly complex and manages too much state. The logic should be refactored into custom hooks (e.g., , ) and smaller, specialized components.

**key api endpoints**
- : User login.
- : Get current user details.
- : CRUD for users.
- : Upload property data CSV.
- : Assign properties to employees.
- : Get statistics for the admin dashboard.
- : Export data to Excel.
- : Export submissions to a PDF report.
- : Get assigned properties for an employee.
- : Submit a survey for a property.

**Critical Info for New Agent**
- You are resuming mid-way through a major refactoring effort requested by the user. Your first task is to complete this implementation. The application is currently in a broken state.
- The mobile photo watermark bug is a key issue to resolve. The attempted fix needs to be thoroughly tested from a mobile perspective.
- The tech stack is FastAPI + React + **MongoDB** (not PostgreSQL as mentioned in the initial prompt).
- All file uploads (photos, signatures) are being saved to the local filesystem at .

**documents and test reports created in this job**
- 
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (LATEST):** Requested a massive list of changes: new roles (Surveyor, Supervisor, etc.), updated Excel format, new dashboard stats, workflow changes (Approve/Reject), and many new fields for the survey form. **Status: IN PROGRESS**.
2.  **User:** Reported the watermark issue on mobile camera photos and requested UI changes for camera/upload buttons and a full-width signature pad. **Status: Partially Addressed (bug remains).**
3.  **User:** Reported that the watermark was not appearing on photos. **Status: Addressed (but led to the mobile-specific bug).**
4.  **User:** Requested PDF export with watermarked photos and signatures. **Status: Completed.**
5.  **User:** Requested two new features: digital signatures and watermarking photos with GPS/timestamp. **Status: Completed.**
6.  **User:** Confirmed satisfaction with previous state. **Status: Acknowledged.**
7.  **User:** Requested removal of Made with Emergent badge. **Status: Completed.**

**Project Health Check:**
- **Broken:** The application is currently broken due to an in-progress major refactor. The backend models and frontend components are out of sync.
- **Mocked:** GPS functionality does not work in the development environment and returns default coordinates. This is expected.

**3rd Party Integrations**
- None.

**Testing status**
- **Testing agent used after significant changes:** YES (once, after initial MVP build).
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** None.
- **Known regressions:** The photo watermarking feature regressed on mobile devices after its initial implementation.

**Credentials to test flow:**
- **Admin:**  / 
- **Employee:** An employee user (e.g.,  / ) needs to be created by the admin first.

**What agent forgot to execute**
The agent did not finish the large set of changes requested by the user in the last message (#212). It started the work but was interrupted, leaving the application in an inconsistent state. The next agent must complete this task.</analysis>
